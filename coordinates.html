<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BedSpace Navigator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #f0f0f0; }
        #container { text-align: center; padding: 20px; }
        #coords { font-size: 24px; font-weight: bold; margin: 20px 0; }
        #map { height: 400px; width: 100%; max-width: 600px; margin: 0 auto; border: 1px solid #ccc; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px; }
        input { padding: 8px; font-size: 16px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>BedSpace Navigator</h1>
        <div id="coords">X: 0, Y: 0, Z: 0</div>
        <input type="text" id="address" placeholder="Enter bed address or use GPS">
        <button onclick="setBedLocation()">Set Bed Location</button>
        <button onclick="setBedWithGPS()">Use Current Location as Bed</button>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Cookie handling
        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(JSON.stringify(value))}; expires=${expires}; path=/`;
        }
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
            return null;
        }

        // Haversine formula for distance in meters
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) ** 2 + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Calculate X, Z coordinates
        function calculateCoordinates(bedLat, bedLon, userLat, userLon) {
            const R = 6371e3; // Earth's radius in meters
            const Δlat = (userLat - bedLat) * Math.PI / 180;
            const Δlon = (userLon - bedLon) * Math.PI / 180;
            const meanLat = ((bedLat + userLat) / 2) * Math.PI / 180;
            const x = R * Δlon * Math.cos(meanLat); // East-West (East: +X, West: -X)
            const z = -R * Δlat; // North-South (South: +Z, North: -Z)
            return { x: Math.round(x), z: Math.round(z) };
        }

        // Initialize map
        const map = L.map('map').setView([0, 0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        let userMarker = L.marker([0, 0]).addTo(map);
        let bedMarker = null;

        // Load bed location from cookie
        let bed = getCookie('bedLocation') || null;

        // Update coordinates display
        function updateCoordinates(pos) {
            if (!bed) {
                document.getElementById('coords').textContent = 'Set bed location first';
                return;
            }
            const { x, z } = calculateCoordinates(bed.lat, bed.lon, pos.coords.latitude, pos.coords.longitude);
            const y = Math.round(pos.coords.altitude || 0); // Fallback to 0 if no altitude
            document.getElementById('coords').textContent = `X: ${x}, Y: ${y}, Z: ${z}`;
            userMarker.setLatLng([pos.coords.latitude, pos.coords.longitude]);
            map.setView([pos.coords.latitude, pos.coords.longitude], 13);
        }

        // Geolocation watch
        function startTracking() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateCoordinates, err => {
                    console.error(err);
                    alert('Geolocation error: ' + err.message);
                }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            } else {
                alert('Geolocation not supported');
            }
        }

        // Set bed location via address
        async function setBedLocation() {
            const address = document.getElementById('address').value;
            if (!address) {
                alert('Please enter an address');
                return;
            }
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`);
                const data = await response.json();
                if (data.length === 0) {
                    alert('Address not found');
                    return;
                }
                const { lat, lon } = data[0];
                // Fetch altitude from OpenTopoData
                const topoResponse = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lon}`);
                const topoData = await topoResponse.json();
                const altitude = topoData.results[0].elevation || 0;
                bed = { lat: parseFloat(lat), lon: parseFloat(lon), altitude };
                setCookie('bedLocation', bed, 30);
                if (bedMarker) map.removeLayer(bedMarker);
                bedMarker = L.marker([lat, lon], { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41] }) }).addTo(map);
                alert('Bed location set');
            } catch (err) {
                console.error(err);
                alert('Error setting bed location');
            }
        }

        // Set bed location using current GPS
        function setBedWithGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    const topoResponse = await fetch(`https://api.opentopodata.org/v1/srtm90m?locations=${lat},${lon}`);
                    const topoData = await topoResponse.json();
                    const altitude = topoData.results[0].elevation || 0;
                    bed = { lat, lon, altitude };
                    setCookie('bedLocation', bed, 30);
                    if (bedMarker) map.removeLayer(bedMarker);
                    bedMarker = L.marker([lat, lon], { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41] }) }).addTo(map);
                    alert('Bed location set to current position');
                }, err => {
                    console.error(err);
                    alert('Error getting GPS: ' + err.message);
                });
            } else {
                alert('Geolocation not supported');
            }
        }

        // Initialize
        if (bed) {
            bedMarker = L.marker([bed.lat, bed.lon], { icon: L.icon({ iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png', iconSize: [25, 41] }) }).addTo(map);
            map.setView([bed.lat, bed.lon], 13);
        }
        startTracking();
    </script>
</body>
</html>
